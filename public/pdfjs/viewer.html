<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>PDF.js Viewer – Maths Upload</title>
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
    #top{display:flex;gap:8px;align-items:center;padding:8px;border-bottom:1px solid #eee}
    #viewport{height:calc(100vh - 48px);overflow:auto;background:#f7f7f7;padding:8px}
    canvas{display:block;margin:12px auto;box-shadow:0 2px 8px rgba(0,0,0,.08);background:#fff}
    button{padding:.4rem .7rem;border-radius:8px;border:1px solid #ddd;background:#fff;cursor:pointer}
    input[type="range"]{width:200px}
  </style>
</head>
<body>
  <div id="top">
    <button id="prev">◀︎ Page</button>
    <button id="next">Page ▶︎</button>
    <span id="pageInfo"></span>
    <label style="margin-left:12px">Zoom <input id="zoom" type="range" min="50" max="200" value="100"></label>
    <a id="download" target="_blank" rel="noopener" style="margin-left:auto">Télécharger</a>
  </div>
  <div id="viewport"></div>

  <script type="module">
    import * as pdfjsLib from 'https://unpkg.com/pdfjs-dist@4.7.76/build/pdf.mjs';
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@4.7.76/build/pdf.worker.min.mjs';

    const params = new URLSearchParams(location.search);
    const url = params.get('file');
    const viewport = document.getElementById('viewport');
    const pageInfo = document.getElementById('pageInfo');
    const dl = document.getElementById('download');
    const prevBtn = document.getElementById('prev');
    const nextBtn = document.getElementById('next');
    const zoomInput = document.getElementById('zoom');

    if(!url){ viewport.textContent = 'Paramètre ?file manquant.'; throw new Error('file param required'); }
    dl.href = url;

    let pdfDoc = null;
    let pageNum = 1;
    let scale = 1;

    const renderPage = async (num) => {
      const page = await pdfDoc.getPage(num);
      const viewportPdf = page.getViewport({ scale });
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = viewportPdf.width;
      canvas.height = viewportPdf.height;
      viewport.innerHTML = '';
      viewport.appendChild(canvas);
      await page.render({ canvasContext: ctx, viewport: viewportPdf }).promise;
      pageInfo.textContent = `Page ${num} / ${pdfDoc.numPages}`;
    };

    pdfjsLib.getDocument(url).promise.then(doc => {
      pdfDoc = doc;
      renderPage(pageNum);
    }).catch(err => {
      viewport.textContent = 'Impossible de charger le PDF.';
      console.error(err);
    });

    prevBtn.onclick = () => { if(pageNum>1){ pageNum--; renderPage(pageNum); } };
    nextBtn.onclick = () => { if(pdfDoc && pageNum < pdfDoc.numPages){ pageNum++; renderPage(pageNum); } };
    zoomInput.oninput = () => { scale = Number(zoomInput.value)/100; renderPage(pageNum); };
  </script>
</body>
</html>